{% extends 'base.html' %}
{% load static %}

{% block content %}
<link rel="stylesheet" href="{% static 'css/nutrition.css' %}">

<div class="wrapper">
    <div class="card">

        <!-- HEADER -->
        <div
            style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 20px;">
            <div>
                <h2>Coach Dashboard</h2>
                <p style="margin-top: -20px; margin-bottom: 10px;">Manage your athletes and track their progress.</p>
            </div>
            <a href="{% url 'coach_assign_athlete' %}" class="btn primary">
                Assign New Athlete
            </a>
        </div>

        <!-- 1. ASSIGNED ATHLETES -->
        <h3>Assigned Athletes</h3>

        {% if athletes %}
        <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                <thead>
                    <tr style="text-align: left; border-bottom: 2px solid #eee;">
                        <th style="padding: 12px; color: #444;">Athlete Name</th>
                        <th style="padding: 12px; color: #444;">Sport</th>
                        <th style="padding: 12px; color: #444;">Status</th>
                        <th style="padding: 12px; color: #444;">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for athlete in athletes %}
                    <tr style="border-bottom: 1px solid #eee;">
                        <td style="padding: 12px; font-weight: 500;">
                            {{ athlete.user.username }}
                        </td>
                        <td style="padding: 12px; color: #666;">
                            {{ athlete.sport|default:"—" }}
                        </td>
                        <td style="padding: 12px;">
                            <span
                                style="background:#e8f5e9; color:#2e7d32; padding: 4px 10px; border-radius: 12px; font-size: 0.85rem; font-weight: 600;">
                                Active
                            </span>
                        </td>
                        <td style="padding: 12px;">
                            <a href="{% url 'coach_athlete_detail' athlete.pk %}" class="btn link"
                                style="padding: 0; color: #0d47a1; font-weight: 600;">
                                View Profile
                            </a>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="alert" style="background-color: #f5f5f5; color: #666; border-color: #ddd;">
            You have no athletes assigned yet.
        </div>
        {% endif %}


        <!-- 2. UNASSIGNED ATHLETES -->
        <h3 style="color: #d32f2f; border-bottom-color: #ffebee;">
            Unassigned Athletes <span style="font-size: 0.8em; color: #e57373; font-weight: normal;">(Needs
                Attention)</span>
        </h3>

        {% if unassigned_athletes %}
        <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                <thead>
                    <tr style="text-align: left; border-bottom: 2px solid #ffebee;">
                        <th style="padding: 12px; color: #b71c1c;">Athlete Name</th>
                        <th style="padding: 12px; color: #b71c1c;">Sport</th>
                        <th style="padding: 12px; color: #b71c1c;">Joined</th>
                        <th style="padding: 12px; color: #b71c1c;">Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for athlete in unassigned_athletes %}
                    <tr style="border-bottom: 1px solid #ffebee; background-color: #fffafb;">
                        <td style="padding: 12px; font-weight: 500;">{{ athlete.user.username }}</td>
                        <td style="padding: 12px; color: #666;">{{ athlete.sport|default:"—" }}</td>
                        <td style="padding: 12px; color: #666;">{{ athlete.user.date_joined|date:"M d, Y" }}</td>
                        <td style="padding: 12px;">
                            <form method="POST" action="{% url 'coach_assign_athlete' %}" style="display:inline;">
                                {% csrf_token %}
                                <input type="hidden" name="athlete_id" value="{{ athlete.id }}">
                                <button type="submit" class="btn primary"
                                    style="background-color: #d32f2f; padding: 6px 16px; font-size: 0.85rem;">
                                    Assign to Me
                                </button>
                            </form>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <p style="font-style: italic; opacity: 0.7;">No unassigned athletes found.</p>
        {% endif %}


        <!-- 3. ALL ATHLETES -->
        <h3 style="margin-top: 50px;">All Athletes (System Wide)</h3>

        <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="text-align: left; border-bottom: 2px solid #eee;">
                        <th style="padding: 12px; color: #444;">Athlete Name</th>
                        <th style="padding: 12px; color: #444;">Current Coach</th>
                        <th style="padding: 12px; color: #444;">Sport</th>
                        <th style="padding: 12px; color: #444;">Status</th>
                    </tr>
                </thead>
                <tbody>
                    {% for athlete in all_athletes %}
                    <tr style="border-bottom: 1px solid #eee;">
                        <td style="padding: 12px; font-weight: 500;">{{ athlete.user.username }}</td>
                        <td style="padding: 12px; color: #555;">
                            {% if athlete.coach %}
                            {{ athlete.coach.user.username }}
                            {% if athlete.coach == request.user.userprofile %}
                            <span
                                style="font-size:0.8em; color: #2e7d32; font-weight: bold; margin-left: 5px;">(You)</span>
                            {% endif %}
                            {% else %}
                            <span style="color: #d32f2f; font-weight: 500;">Unassigned</span>
                            {% endif %}
                        </td>
                        <td style="padding: 12px; color: #666;">{{ athlete.sport|default:"—" }}</td>
                        <td style="padding: 12px;">
                            {% if athlete.coach %}
                            <span style="color: #2e7d32; font-weight: 600; font-size: 0.9rem;">Active</span>
                            {% else %}
                            <span style="color: #e65100; font-weight: 600; font-size: 0.9rem;">Pending</span>
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

    </div>
</div>

{% endblock %}